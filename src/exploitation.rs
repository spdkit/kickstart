// [[file:../kickstart.note::8c5068e5][8c5068e5]]
use crate::common::*;
use crate::core::*;

use gchemol::Molecule;
use vecfx::*;
// 8c5068e5 ends here

// [[file:../kickstart.note::69c322bc][69c322bc]]
/// Exploitation/local search
#[derive(Debug, Default, Clone)]
pub struct Exploitation {
    /// If defined, will enable minima hopping for local search
    minima_hopping: Option<PathBuf>,
}

impl Exploitation {
    /// Perform minimal hopping local search using `bbm_dir`
    pub fn set_minima_hopping(&mut self, bbm_dir: &Path) -> &mut Self {
        self.minima_hopping = bbm_dir.to_owned().into();
        self
    }
}
// 69c322bc ends here

// [[file:../kickstart.note::78420e2a][78420e2a]]
/// Carry out a local search from `parent` molecule inspired by the variable
/// depth search (VDS) algorithm.
///
/// # Return
///
/// * returns the best molecule with lowest energy during local search.
///
fn variable_depth_search(evaluated_genome: &EvaluatedGenome) -> Result<MolGenome> {
    let EvaluatedGenome {
        genome: old_genome,
        energy: ini_energy,
    } = evaluated_genome;
    // FIXME: dirty
    let ini_energy = *ini_energy;

    // search options
    let search_width = 5;
    let search_depth = 3;
    let max_iterations = 10;

    let parent_molecule = old_genome.decode();
    let mut old_energy = ini_energy;
    info!("initial genome {} energy = {}", old_genome, old_energy);
    let mut search_results = vec![(old_genome.clone(), old_energy)];
    let mut istop = 0;
    for icycle in 0.. {
        info!("{:=^72}", format!(" vds iteration {} ", icycle));
        let best = get_best_among_local_mutated(&parent_molecule, search_width);
        let new_genome = best.genome;
        let new_energy = best.energy;
        info!(
            "current best in {} candidates: {} energy = {}",
            search_width, new_genome, new_energy
        );

        if new_energy > old_energy {
            istop += 1;
        }
        // reset stop flag when energy is decreasing
        else {
            istop = 0;
        }

        // stop iterations when situation get worse
        if istop >= search_depth {
            break;
        }
        old_energy = new_energy;
        search_results.push((new_genome, new_energy));
        if icycle >= max_iterations {
            info!("Max allowed iteration reached during vds.");
            break;
        }
    }

    // select the best one during search.
    // search_results.sort_by(|a, b| float_ordering_minimize(&a.1, &b.1));
    search_results.sort_by_key(|a| a.1.as_ordered_float());

    // increase genome age here
    let (best_genome, best_energy) = search_results.remove(0);
    let best_genome = if old_genome.uid() == best_genome.uid() {
        old_genome.aged()
    } else {
        best_genome
    };
    info!(
        "evolution result: {} => {}, {:-10.4} => {:-10.4} ",
        old_genome, best_genome, ini_energy, best_energy,
    );
    Ok(best_genome)
}

/// Core iteration for vds
///
/// Return the best from `n` mutated Molecule using rand-bond-mutation algorithm.
fn get_best_among_local_mutated(mol: &Molecule, n: usize) -> EvaluatedGenome {
    let mutated_molecules: Vec<_> = (0..n)
        .into_par_iter()
        .map(|_| crate::mutation::random_bond_mutate(&mol, 1).expect("local mutation failure"))
        .collect();

    // carry out geometry optimization for mutated molecules and take the best one
    let best = crate::model::evaluate_molecules(mutated_molecules)
        .expect("comput mols failure")
        .into_iter()
        .min_by_key(|e| e.energy.as_ordered_float())
        .unwrap();
    best
}
// 78420e2a ends here

// [[file:../kickstart.note::b93de9df][b93de9df]]
use ::surface::cli::MinimaHopping;
use gosh::model::ModelProperties;

fn mol_to_model_properties_adhoc(mol: &Molecule) -> ModelProperties {
    let title = mol.title();
    let mut mp = ModelProperties::default();
    if let Some(energy) = get_energy_from_title(&title) {
        mp.set_molecule(mol.clone());
        mp.set_energy(energy);
        mp
    } else {
        panic!("failed to get energy from: {title}");
    }
}

// energy =      -380.9962 nvisit=3
fn get_energy_from_title(title: &str) -> Option<f64> {
    title.split_whitespace().skip(2).take(1).next().and_then(|x| x.parse().ok())
}

#[test]
fn test_parse_energy_from_xyz() {
    let title = "energy =      -380.9962 nvisit=3";
    assert_eq!(-380.9962, get_energy_from_title(title).unwrap());
}

fn comput_fingerprint(mol: &Molecule) -> String {
    use spdkit::prelude::*;

    let mut mol = mol.clone();
    mol.rebond();
    mol.fingerprint()
}

pub(self) fn local_search_minima_hopping(evaluated: &EvaluatedGenome, bbm_dir: &Path) -> Result<MolGenome> {
    use gchemol::prelude::*;
    use gut::cli::*;

    let EvaluatedGenome {
        energy: old_energy,
        genome: old_genome,
    } = evaluated;

    let old_mol = old_genome.decode();
    let old_fp = comput_fingerprint(&old_mol);
    info!("initial genome {old_genome} energy = {old_energy}");

    let bbm_dir = bbm_dir.display().to_string();
    old_mol.to_file("input.xyz")?;
    let args = vec![
        "mhm",
        "input.xyz",
        "--config",
        "mhm.conf",
        "-o",
        "mhm-opt.xyz",
        "-t",
        &bbm_dir,
    ];
    info!("mhm local search with args: {args:?}");
    let mhm = MinimaHopping::parse_from(args);
    if let Err(err) = mhm.run() {
        eprintln!("mhm failed with message:\n {err}");
    }

    // record all minima found using minima hopping for bench-marking
    let mols: Vec<_> = gchemol::io::read("mhm-opt.xyz")?.collect();
    let mut all: Vec<_> = mols
        .iter()
        // FIXME: 可能会导致重复添加已计算的结果
        // .take(1)
        .map(|mol| {
            let mp = mol_to_model_properties_adhoc(mol);
            let EvaluatedGenome {
                genome: new_genome,
                energy: new_energy,
            } = mp.encode_as_evaluated();
            (mol.clone(), new_genome, new_energy)
        })
        .collect();
    assert!(all.len() >= 1, "mhm produced no result");

    let (mol, new_genome, new_energy) = all.remove(0);
    println!(
        "evolution result: {} => {}, {:-10.4} => {:-10.4} ",
        old_genome, new_genome, old_energy, new_energy,
    );

    // check fingerprint
    let new_fp = comput_fingerprint(&mol);
    if new_fp == old_fp {
        Ok(old_genome.aged())
    } else {
        Ok(new_genome)
    }
}
// b93de9df ends here

// [[file:../kickstart.note::d42b8adc][d42b8adc]]
impl Exploitation {
    pub fn perform_local_search(&self, evaluated: &EvaluatedGenome) -> Result<MolGenome> {
        if let Some(bbm_dir) = self.minima_hopping.as_ref() {
            info!("Exploit using minima hopping algorithm with bbm: {bbm_dir:?}");
            local_search_minima_hopping(evaluated, bbm_dir)
        } else {
            variable_depth_search(evaluated)
        }
    }
}
// d42b8adc ends here
