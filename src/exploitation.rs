// imports

// [[file:~/Workspace/Programming/structure-predication/kickstart/kickstart.note::*imports][imports:1]]
use crate::common::*;
use crate::core::*;
use crate::model::*;

use spdkit::common::float_ordering_minimize;
// imports:1 ends here

// variable depth search

// [[file:~/Workspace/Programming/structure-predication/kickstart/kickstart.note::*variable%20depth%20search][variable depth search:1]]
/// Carry out a local search from `old_genome` inspired by the variable depth
/// search (VDS) algorithm.
///
/// # Return
///
/// * the best MolGenome during local search neighbors from `old_genome`.
///
pub(crate) fn variable_depth_search(old_genome: &MolGenome) -> MolGenome {
    // search options
    let search_width = 5;
    let search_depth = 3;
    let max_iterations = 10;

    // core iteration for vds
    let iteration = || {
        // start mutation
        let mut mutated: Vec<_> = (0..search_width)
            .into_par_iter()
            .map(|_| old_genome.mutated_with_energy())
            .collect();
        // take current best
        mutated.sort_by(|a, b| float_ordering_minimize(&a.1, &b.1));
        let best = &mutated[0].0;
        mutated[0].clone()
    };

    let ini_energy = old_genome.decode().energy();
    let mut old_energy = ini_energy;
    info!("initial genome {} energy = {}", old_genome, old_energy);
    let mut search_results = vec![(old_genome.clone(), old_energy)];
    let mut istop = 0;

    for icycle in 0.. {
        info!("{:=^72}", format!(" vds iteration {} ", icycle));
        let (new_genome, new_energy) = iteration();
        info!(
            "current best in {} candidates: {} energy = {}",
            search_width, new_genome, new_energy
        );

        if new_energy > old_energy {
            istop += 1;
        }
        // reset stop flag when energy is decreasing
        else {
            istop = 0;
        }

        // stop iterations when situation get worse
        if istop >= search_depth {
            break;
        }
        old_energy = new_energy;
        search_results.push((new_genome, new_energy));
        if icycle >= max_iterations {
            info!("Max allowed iteration reached during vds.");
            break;
        }
    }

    // select the best one during search.
    search_results.sort_by(|a, b| float_ordering_minimize(&a.1, &b.1));

    let best = search_results.remove(0);
    println!(
        "vds result: {} => {}, {:-10.4} => {:-10.4} ",
        old_genome, best.0, ini_energy, best.1,
    );
    best.0
}

impl MolGenome {
    /// Return a mutated MolGenome using rand-bond-mutation algorithm.
    pub(crate) fn mutated_with_energy(&self) -> (Self, f64) {
        let mol = self.decode();
        let mol = crate::mutation::random_bond_mutate(&mol, 1)
            .expect("mutate molecule failed")
            .get_optimized_molecule()
            .expect("mutation opt failed");

        let energy = mol.energy();
        let genome = mol.encode();
        debug!("mutant energy of {} = {}", genome, energy);
        (genome, energy)
    }
}
// variable depth search:1 ends here

// test

// [[file:~/Workspace/Programming/structure-predication/kickstart/kickstart.note::*test][test:1]]
#[test]
#[ignore]
fn test_vds() -> Result<()> {
    use gchemol::prelude::*;
    use gosh::gchemol;

    let mols = gchemol::io::read("/tmp/g000.xyz")?;
    let ini_genome = mols[0].encode();
    let _ = variable_depth_search(&ini_genome);
    Ok(())
}
// test:1 ends here
