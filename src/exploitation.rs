// [[file:../kickstart.note::*imports][imports:1]]
use crate::common::*;
use crate::core::*;

use gchemol::Molecule;
// imports:1 ends here

// [[file:../kickstart.note::69c322bc][69c322bc]]
/// Exploitation/local search
#[derive(Debug, Default, Clone)]
pub struct Exploitation {
    /// If defined, will enable minima hopping for local search
    minima_hopping: Option<PathBuf>,

    bbm_dir: Option<PathBuf>,
}

impl Exploitation {
    pub fn set_minima_hopping(&mut self, conf: &Path) -> &mut Self {
        self.minima_hopping = conf.to_owned().into();
        self
    }

    pub fn set_bbm_dir(&mut self, dir: &Path) -> &mut Self {
        self.bbm_dir = dir.to_owned().into();
        self
    }
}
// 69c322bc ends here

// [[file:../kickstart.note::78420e2a][78420e2a]]
/// Carry out a local search from `parent` molecule inspired by the variable
/// depth search (VDS) algorithm.
///
/// # Return
///
/// * returns the best molecule with lowest energy during local search.
///
fn variable_depth_search(old_genome: &MolGenome) -> MolGenome {
    use spdkit::common::float_ordering_minimize;

    // search options
    let search_width = 5;
    let search_depth = 3;
    let max_iterations = 10;

    let parent_molecule = old_genome.decode();
    let ini_energy = old_genome.energy();
    let mut old_energy = ini_energy;
    info!("initial genome {} energy = {}", old_genome, old_energy);
    let mut search_results = vec![(old_genome.clone(), old_energy)];
    let mut istop = 0;
    for icycle in 0.. {
        info!("{:=^72}", format!(" vds iteration {} ", icycle));
        let best = get_best_among_local_mutated(&parent_molecule, search_width);
        let new_genome = best.genome;
        let new_energy = best.energy;
        info!(
            "current best in {} candidates: {} energy = {}",
            search_width, new_genome, new_energy
        );

        if new_energy > old_energy {
            istop += 1;
        }
        // reset stop flag when energy is decreasing
        else {
            istop = 0;
        }

        // stop iterations when situation get worse
        if istop >= search_depth {
            break;
        }
        old_energy = new_energy;
        search_results.push((new_genome, new_energy));
        if icycle >= max_iterations {
            info!("Max allowed iteration reached during vds.");
            break;
        }
    }

    // select the best one during search.
    search_results.sort_by(|a, b| float_ordering_minimize(&a.1, &b.1));

    // increase genome age here
    let (best_genome, best_energy) = search_results.remove(0);
    let best_genome = if old_genome.uid() == best_genome.uid() {
        old_genome.aged()
    } else {
        best_genome
    };
    println!(
        "evolution result: {} => {}, {:-10.4} => {:-10.4} ",
        old_genome, best_genome, ini_energy, best_energy,
    );
    best_genome
}

/// Core iteration for vds
///
/// Return the best from `n` mutated Molecule using rand-bond-mutation algorithm.
fn get_best_among_local_mutated(mol: &Molecule, n: usize) -> EvaluatedGenome {
    let mutated_molecules: Vec<_> = (0..n)
        .into_par_iter()
        .map(|_| crate::mutation::random_bond_mutate(&mol, 1).expect("local mutation failure"))
        .collect();

    // carry out geometry optimization
    let evaluated = crate::model::compute(mutated_molecules)
        .expect("compt failure")
        .into_iter()
        .map(|mp| mp.encode_as_evaluated())
        .min_by(|a, b| a.energy.partial_cmp(&b.energy).expect("cmp nan"))
        .unwrap();

    evaluated
}
// 78420e2a ends here

// [[file:../kickstart.note::b93de9df][b93de9df]]
use ::surface::cli::MinimaHopping;
use gosh::model::ModelProperties;

fn mol_to_model_properties_adhoc(mol: &Molecule) -> ModelProperties {
    let title = mol.title();
    let mut mp = ModelProperties::default();
    if let Some(energy) = get_energy_from_title(&title) {
        mp.set_molecule(mol.clone());
        mp.set_energy(energy);
        mp
    } else {
        panic!("failed to get energy from: {title}");
    }
}

// energy =      -380.9962 nvisit=3
fn get_energy_from_title(title: &str) -> Option<f64> {
    title.split_whitespace().skip(2).take(1).next().and_then(|x| x.parse().ok())
}

#[test]
fn test_parse_energy_from_xyz() {
    let title = "energy =      -380.9962 nvisit=3";
    assert_eq!(-380.9962, get_energy_from_title(title).unwrap());
}

fn local_search_minima_hopping(mol: &Molecule, bbm_dir: &Path) -> Result<MolGenome> {
    use gchemol::prelude::*;
    use gut::cli::*;

    let bbm_dir = bbm_dir.display().to_string();
    mol.to_file("input.xyz")?;
    let args = vec![
        "mhm",
        "input.xyz",
        "--config",
        "mhm.conf",
        "-o",
        "mhm-opt.xyz",
        "-t",
        &bbm_dir,
    ];
    let mhm = MinimaHopping::parse_from(args);
    mhm.run()?;

    if let Some(mp) = gchemol::io::read("mhm-opt.xyz")?
        .next()
        .map(|mol| mol_to_model_properties_adhoc(&mol))
    {
        Ok(mp.encode())
    } else {
        panic!("mhm produced no mols")
    }
}
// b93de9df ends here

// [[file:../kickstart.note::d42b8adc][d42b8adc]]
impl Exploitation {
    pub fn perform_local_search(&self, genome: &MolGenome) -> MolGenome {
        if let Some(mhm) = self.minima_hopping.as_ref() {
            info!("Exploit using minima hopping algorithm");
            let mol = genome.decode();
            let energy = genome.energy();
            info!("initial genome {genome} energy = {energy}");
            // FIXME: allow user set
            let bbm_dir: &Path = self.bbm_dir.as_ref().map(|p| p.as_ref()).unwrap_or("/share/apps/ase/sp-brenner-interactive".as_ref());
            local_search_minima_hopping(&mol, bbm_dir).unwrap()
        } else {
            variable_depth_search(genome)
        }
    }
}
// d42b8adc ends here
