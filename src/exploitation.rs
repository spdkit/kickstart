// imports

// [[file:~/Workspace/Programming/structure-predication/kickstart/kickstart.note::*imports][imports:1]]
use crate::common::*;
use crate::core::*;

use gchemol::Molecule;
// imports:1 ends here

// core

// [[file:~/Workspace/Programming/structure-predication/kickstart/kickstart.note::*core][core:1]]
/// Carry out a local search from `parent` molecule inspired by the variable
/// depth search (VDS) algorithm.
///
/// # Return
///
/// * returns the best molecule with lowest energy during local search.
///
pub(crate) fn variable_depth_search(old_genome: &MolGenome) -> MolGenome {
    use spdkit::common::float_ordering_minimize;

    // search options
    let search_width = 5;
    let search_depth = 3;
    let max_iterations = 10;

    let parent_molecule = old_genome.decode();
    let ini_energy = old_genome.energy();
    let mut old_energy = ini_energy;
    info!("initial genome {} energy = {}", old_genome, old_energy);
    let mut search_results = vec![(old_genome.clone(), old_energy)];
    let mut istop = 0;
    for icycle in 0.. {
        info!("{:=^72}", format!(" vds iteration {} ", icycle));
        let best = get_best_among_local_mutated(&parent_molecule, search_width);
        let new_genome = best.genome;
        let new_energy = best.energy;
        info!(
            "current best in {} candidates: {} energy = {}",
            search_width, new_genome, new_energy
        );

        if new_energy > old_energy {
            istop += 1;
        }
        // reset stop flag when energy is decreasing
        else {
            istop = 0;
        }

        // stop iterations when situation get worse
        if istop >= search_depth {
            break;
        }
        old_energy = new_energy;
        search_results.push((new_genome, new_energy));
        if icycle >= max_iterations {
            info!("Max allowed iteration reached during vds.");
            break;
        }
    }

    // select the best one during search.
    search_results.sort_by(|a, b| float_ordering_minimize(&a.1, &b.1));

    // increase genome age here
    let (best_genome, best_energy) = search_results.remove(0);
    let best_genome = if old_genome.uid() == best_genome.uid() {
        old_genome.aged()
    } else {
        best_genome
    };
    println!(
        "evolution result: {} => {}, {:-10.4} => {:-10.4} ",
        old_genome, best_genome, ini_energy, best_energy,
    );
    best_genome
}

/// Core iteration for vds
///
/// Return `n` mutated Molecule using rand-bond-mutation algorithm.
fn get_best_among_local_mutated(mol: &Molecule, n: usize) -> EvaluatedGenome {
    let mutated_molecules: Vec<_> = (0..n)
        .into_par_iter()
        .map(|_| crate::mutation::random_bond_mutate(&mol, 1).expect("local mutation failure"))
        .collect();

    // carry out geometry optimization
    let evaluated = crate::model::compute(mutated_molecules)
        .expect("compt failure")
        .into_iter()
        .map(|mp| mp.encode_as_evaluated())
        .min_by(|a, b| a.energy.partial_cmp(&b.energy).expect("cmp nan"))
        .unwrap();

    evaluated
}
// core:1 ends here
